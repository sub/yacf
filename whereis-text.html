<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="jquery.mobile-1.0a2pre.min.css" />
    <script src="scripts/phonegap.js"></script>
    <script src="scripts/jquery-1.4.3.min.js"></script>
    <script src="scripts/jquery.mobile-1.0a2pre.min.js"></script>
    <script type="text/javascript"
	    src="http://maps.google.com/maps/api/js?sensor=true">
    </script>

    <script src="scripts/Lawnchair.js"></script>
    <script src="scripts/LawnchairAdaptorHelpers.js"></script>
    <script src="scripts/DOMStorageAdaptor.js"></script>

    <style type="text/css">
      #map_canvas { height: 40% }
    </style>
    
    <script type="text/javascript">
    function loader() {
	var state = document.readyState;

	if (typeof(localStorage) == 'undefined' ) {
	    alert('Upgrade your browser as it does not support HTML5 localStorage.');
	} 

	if (state == 'loaded' || state == 'complete') {
            getLocation();
	} else {
            if (navigator.userAgent.indexOf('Browzr') > -1) {
		setTimeout(getLocation, 250);
            } else {
		document.addEventListener('deviceready',getLocation,false);
	    }
	}
    }

    var getLocation = function() {
	var suc = function(p) {
	    initializeMap(p);
	};
	var fail = function() {
	    alert("NOT ABLE TO GET THE CURRENT POSITION");
	};
	navigator.geolocation.getCurrentPosition(suc,fail);
    }

    function initializeMap(p) {
        var gpsstore = new Lawnchair({table: 'mygps', adaptor: 'dom'});
	var destination;
        var to_lat;
        var to_long;
	var fromLatLng;
	var toLatLng;
	var directionsDisplay = new google.maps.DirectionsRenderer();
	var directionsService = new google.maps.DirectionsService();
	var map;

	console.log("actual latitude " + p.coords.latitude);
	console.log("actual longitude " + p.coords.longitude);
        // retrieve my data from my stores
        gpsstore.get('destination', function(r) {
            destination = r.value;
	    console.log("destination " + destination);
        });
        gpsstore.get('latitude', function(r) {
            to_lat = r.value; 
	    console.log("to_lat " + to_lat);
        });
        gpsstore.get('longitude', function(r) {
            to_long = r.value;
	    console.log("to_long " + to_long);
        });

	// ATTENTION!! fake pos!!
	//toLatLng = new google.maps.LatLng(to_lat, to_long);
	toLatLng = new google.maps.LatLng(to_lat+1, to_long-2);
	fromLatLng = new google.maps.LatLng(p.coords.latitude, p.coords.longitude);
	console.log(fromLatLng);
	console.log(toLatLng);

	var request = {
	    origin:fromLatLng, 
	    destination:toLatLng,
	    travelMode: google.maps.DirectionsTravelMode.DRIVING
	    // WALKING, BICYCLING
	};

	directionsService.route(request, function(result, status) {
	    console.log("waiting for google service");
	    if (status == google.maps.DirectionsStatus.OK) {
		console.log("google returned OK");
		console.log(result);
		//var warnings = document.getElementById("warnings_panel");
		//warnings.innerHTML = "" + response.routes[0].warnings + "";
		directionsDisplay.setDirections(result);
		showSteps(result);
	    }
	});
    }

    function showSteps(directionResult) {
	// For each step, place a marker, and add the text to the marker's
	// info window. Also attach the marker to an array so we
	// can keep track of it and remove it when calculating new
	// routes.
	var myRoute = directionResult.routes[0].legs[0];
	var newText;
	newText = "<li data-role=\"list-divider\">Total time</li>"
	newText += "<li>" + myRoute.duration.text + "</li>";
	newText += "<li data-role=\"list-divider\">FROM</li>"
	newText += "<li>" + myRoute.start_address + "</li>";
	
	newText += "<li data-role=\"list-divider\">Directions</li>"
	//TODO: paginate
	for (var i = 0; i < myRoute.steps.length; i++) {
	    newText += "<li>" + i + " " + myRoute.steps[i].instructions;
	    newText += " " + myRoute.steps[i].distance.text  + "</li>" ;
	}

	newText += "<li data-role=\"list-divider\">TO</li>"
	newText += "<li>" + myRoute.end_address + "</li>";
	$('.ui-listview').html(newText).listview("refresh");
    }

</script>
    
  </head>
    <body onload="loader()">

      <div data-role="page" data-theme="b" id="whereis">    
	<div data-role="header">
	  <h1>yacf - directions</h1>
	</div>
	
	<div data-role="content" class="content">
	  <ul data-role="listview" data-theme="c" id="list-directions"> 
	</ul>  
	  
	</div>
	
	<div data-role="footer">
	  <h4>@fitzkarraldo</h4>
	</div>
      </div>
      
    </body>
    
</html>
